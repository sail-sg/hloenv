default:
  image: harbor.seacloud.garenanow.com/sail/python_bazel_golden:latest
  tags:
    - sail
  before_script:
    - python3 -m pip config set global.index-url http://pypi.ai.seacloud.garenanow.com/root/dev
    - python3 -m pip config set global.trusted-host pypi.ai.seacloud.garenanow.com

stages:
  - lint
  - build
  - test
  - deploy

flake8:
  stage: lint
  script:
    - flake8 altgraph/ --count --show-source --statistics

cpplint:
  stage: lint
  script:
    - cpplint --root=. --recursive altgraph/

clang-format:
  stage: lint
  script:
    - clang-format-11 --style=Google -i $(find altgraph/ -regex ".*\.\(proto\|cpp\|c\|cc\|cxx\|hpp\|h\|hxx\)$") -n -Werror

buildifier:
  stage: lint
  script:
    - buildifier -r -lint warn altgraph/


build:
  stage: build
  script:
    - mkdir ./dist
    - bazel build --remote_cache=http://bazel-cache-http.ai.seacloud.garenanow.com //:setup
    - bazel run --remote_cache=http://bazel-cache-http.ai.seacloud.garenanow.com //:setup
    - ls bazel-bin/setup.runfiles/org_altgraph/dist/*.whl
    - cp "$(ls bazel-bin/setup.runfiles/org_altgraph/dist/*.whl)" "./dist/"
    - touch "./dist/$CI_COMMIT_SHA"
    - tar cf dist.tar dist
  artifacts:
    paths:
      - dist.tar

test:
  stage: test
  script:
    - bazel test --action_env=GITLAB_CI="True" --test_output=all --remote_cache=http://bazel-cache-http.ai.seacloud.garenanow.com //tests/...

whl:
  stage: deploy
  only:
    - main
  before_script:
    - pip3 install twine
  script:
    - /tools/deploy_to_pypi.sh dist.tar
